# External Secrets Operator configuration for Tekton git-clone Task
# This creates a secret in the format expected by Tekton's basic-auth workspace
#
# ADR-031: Git credentials for Tekton must be in a different format than BuildConfig
# - BuildConfig uses: username + password keys (type: kubernetes.io/basic-auth)
# - Tekton basic-auth workspace uses: .gitconfig + .git-credentials files
#
# This ExternalSecret syncs from the same source as BuildConfig credentials
# but formats them correctly for Tekton's git-clone Task

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: git-credentials-tekton
  namespace: default
  annotations:
    mlops.dev/description: "Git credentials for Tekton Pipelines (basic-auth format)"
    mlops.dev/related-adr: "ADR-031"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: fake-secretstore  # Replace with your actual SecretStore
    kind: SecretStore
  target:
    name: git-credentials-tekton
    creationPolicy: Owner
    template:
      metadata:
        labels:
          app.kubernetes.io/name: jupyter-notebook-validator-operator
          app.kubernetes.io/component: git-credentials
          mlops.dev/credential-type: tekton-basic-auth
      # Template to create .gitconfig and .git-credentials files
      data:
        .gitconfig: |
          [credential]
              helper = store
          [credential "https://github.com"]
              helper = store
        .git-credentials: |
          https://{{ .username }}:{{ .password }}@github.com
  data:
    - secretKey: username
      remoteRef:
        key: git-credentials  # Same key as BuildConfig credentials
        property: username
    - secretKey: password
      remoteRef:
        key: git-credentials  # Same key as BuildConfig credentials
        property: password

---
# Alternative: Manual secret creation (for testing without ESO)
# This shows the exact format Tekton's basic-auth workspace expects
apiVersion: v1
kind: Secret
metadata:
  name: git-credentials-tekton-manual
  namespace: default
  labels:
    app.kubernetes.io/name: jupyter-notebook-validator-operator
    app.kubernetes.io/component: git-credentials
    mlops.dev/credential-type: tekton-basic-auth
type: Opaque
stringData:
  .gitconfig: |
    [credential]
        helper = store
    [credential "https://github.com"]
        helper = store
  .git-credentials: |
    https://YOUR_GITHUB_USERNAME:YOUR_GITHUB_TOKEN@github.com

---
# Example: Create from existing git-credentials secret
# This kubectl command converts the existing secret to Tekton format:
#
# USERNAME=$(kubectl get secret git-credentials -n default -o jsonpath='{.data.username}' | base64 -d)
# PASSWORD=$(kubectl get secret git-credentials -n default -o jsonpath='{.data.password}' | base64 -d)
#
# kubectl create secret generic git-credentials-tekton \
#   --from-literal=.gitconfig="[credential]
#     helper = store
# [credential \"https://github.com\"]
#     helper = store" \
#   --from-literal=.git-credentials="https://${USERNAME}:${PASSWORD}@github.com" \
#   -n default

