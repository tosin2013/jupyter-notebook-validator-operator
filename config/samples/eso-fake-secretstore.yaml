# External Secrets Operator (ESO) Test Setup
# This uses the Fake provider for testing ESO integration without cloud credentials
#
# The Fake provider is perfect for:
# - Testing ESO integration
# - CI/CD pipelines
# - Development environments
# - Demonstrations
#
# For production, replace with real providers:
# - AWS Secrets Manager (see ADR-016)
# - Azure Key Vault (see ADR-016)
# - GCP Secret Manager (see ADR-016)
# - HashiCorp Vault (see ADR-017)

---
# SecretStore using Fake provider for testing
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: fake-secretstore
  namespace: mlops
spec:
  provider:
    fake:
      data:
        # AWS credentials (fake values for testing)
        - key: "aws-credentials"
          value: |
            {
              "AWS_ACCESS_KEY_ID": "AKIAIOSFODNN7EXAMPLE",
              "AWS_SECRET_ACCESS_KEY": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
              "AWS_REGION": "us-east-1"
            }
        # Database credentials (fake values for testing)
        - key: "database-config"
          value: |
            {
              "DB_HOST": "postgres.example.com",
              "DB_PORT": "5432",
              "DB_NAME": "mlops_db",
              "DB_USER": "mlops_user",
              "DB_PASSWORD": "fake-password-for-testing"
            }
        # MLflow credentials (fake values for testing)
        - key: "mlflow-credentials"
          value: |
            {
              "MLFLOW_TRACKING_URI": "https://mlflow.example.com",
              "MLFLOW_TRACKING_USERNAME": "mlops_user",
              "MLFLOW_TRACKING_PASSWORD": "fake-mlflow-password"
            }
        # API keys (fake values for testing)
        - key: "api-keys"
          value: |
            {
              "OPENAI_API_KEY": "sk-fake-openai-key-for-testing",
              "HUGGINGFACE_TOKEN": "hf_fake_token_for_testing"
            }

---
# ExternalSecret for AWS credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: aws-credentials-eso
  namespace: mlops
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: fake-secretstore
    kind: SecretStore
  target:
    name: aws-credentials-eso
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: aws-credentials

---
# ExternalSecret for database credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-config-eso
  namespace: mlops
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: fake-secretstore
    kind: SecretStore
  target:
    name: database-config-eso
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: database-config

---
# ExternalSecret for MLflow credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mlflow-credentials-eso
  namespace: mlops
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: fake-secretstore
    kind: SecretStore
  target:
    name: mlflow-credentials-eso
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: mlflow-credentials

---
# ExternalSecret for API keys
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-keys-eso
  namespace: mlops
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: fake-secretstore
    kind: SecretStore
  target:
    name: api-keys-eso
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: api-keys

---
# NotebookValidationJob using ESO-synced secrets
apiVersion: mlops.mlops.dev/v1alpha1
kind: NotebookValidationJob
metadata:
  name: eso-integration-test
  namespace: mlops
spec:
  notebook:
    path: simple-test.ipynb
    git:
      url: https://github.com/tosin2013/jupyter-notebook-validator-test-notebooks.git
      ref: main
  podConfig:
    containerImage: quay.io/jupyter/scipy-notebook:latest
    # Use ESO-synced secrets via envFrom
    envFrom:
      - secretRef:
          name: aws-credentials-eso
      - secretRef:
          name: database-config-eso
      - secretRef:
          name: mlflow-credentials-eso
      - secretRef:
          name: api-keys-eso
    # Override specific values if needed
    env:
      - name: TEST_MODE
        value: "true"
      - name: LOG_LEVEL
        value: "DEBUG"

