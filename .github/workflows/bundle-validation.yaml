name: OLM Bundle Validation

on:
  push:
    branches: [ main, 'release-4.18', 'release-4.19', 'release-4.20' ]
    paths:
      - 'bundle/**'
      - 'config/manifests/**'
      - 'api/**'
      - 'catalog/**'
      - '.github/workflows/bundle-validation.yaml'
      - 'Makefile'
  pull_request:
    branches: [ main, 'release-4.18', 'release-4.19', 'release-4.20' ]
    paths:
      - 'bundle/**'
      - 'config/manifests/**'
      - 'api/**'
      - 'catalog/**'
      - '.github/workflows/bundle-validation.yaml'
      - 'Makefile'
  workflow_dispatch:

env:
  GO_VERSION: '1.22'
  OPERATOR_SDK_VERSION: 'v1.37.0'
  OPM_VERSION: 'v1.43.0'

jobs:
  bundle-validate:
    name: Validate OLM Bundle
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install operator-sdk
        run: |
          export ARCH=$(case $(uname -m) in x86_64) echo -n amd64 ;; aarch64) echo -n arm64 ;; *) echo -n $(uname -m) ;; esac)
          export OS=$(uname | awk '{print tolower($0)}')
          export OPERATOR_SDK_DL_URL=https://github.com/operator-framework/operator-sdk/releases/download/${{ env.OPERATOR_SDK_VERSION }}
          curl -LO ${OPERATOR_SDK_DL_URL}/operator-sdk_${OS}_${ARCH}
          chmod +x operator-sdk_${OS}_${ARCH}
          sudo mv operator-sdk_${OS}_${ARCH} /usr/local/bin/operator-sdk
          operator-sdk version

      - name: Validate Bundle (Basic)
        run: |
          echo "ðŸ” Running basic bundle validation..."
          operator-sdk bundle validate ./bundle
          echo "âœ… Basic validation passed"

      - name: Validate Bundle (OperatorHub)
        run: |
          echo "ðŸ” Running OperatorHub validation..."
          operator-sdk bundle validate ./bundle --select-optional name=operatorhub || true
          echo "âœ… OperatorHub validation completed"

      - name: Validate Bundle (Operator Framework Suite)
        run: |
          echo "ðŸ” Running Operator Framework suite validation..."
          operator-sdk bundle validate ./bundle --select-optional suite=operatorframework
          echo "âœ… Operator Framework suite validation passed"

      - name: Check replaces field exists
        run: |
          echo "ðŸ” Checking for replaces field in CSV..."
          if grep -q "replaces:" bundle/manifests/*.clusterserviceversion.yaml; then
            echo "âœ… replaces field found:"
            grep "replaces:" bundle/manifests/*.clusterserviceversion.yaml
          else
            echo "âš ï¸  WARNING: No replaces field found in CSV"
            echo "This may cause issues with OLM upgrade chain"
          fi

      - name: Check OpenShift version annotation
        run: |
          echo "ðŸ” Checking for OpenShift version annotation..."
          if grep -q "com.redhat.openshift.versions" bundle/manifests/*.clusterserviceversion.yaml; then
            echo "âœ… OpenShift version annotation found:"
            grep "com.redhat.openshift.versions" bundle/manifests/*.clusterserviceversion.yaml
          else
            echo "âš ï¸  WARNING: No OpenShift version annotation found"
          fi

  catalog-validate:
    name: Validate FBC Catalog
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install opm
        run: |
          export ARCH=$(case $(uname -m) in x86_64) echo -n amd64 ;; aarch64) echo -n arm64 ;; *) echo -n $(uname -m) ;; esac)
          curl -LO https://github.com/operator-framework/operator-registry/releases/download/${{ env.OPM_VERSION }}/linux-${ARCH}-opm
          chmod +x linux-${ARCH}-opm
          sudo mv linux-${ARCH}-opm /usr/local/bin/opm
          opm version

      - name: Validate FBC Catalog
        run: |
          echo "ðŸ” Validating FBC catalog..."
          opm validate catalog/
          echo "âœ… FBC catalog validation passed"

      - name: Check upgrade chain
        run: |
          echo "ðŸ” Checking upgrade chain in catalog..."
          echo "Upgrade chain entries:"
          grep -A 1 "replaces:" catalog/catalog.yaml || echo "No replaces found in catalog"

  bundle-build:
    name: Build Bundle Image
    runs-on: ubuntu-latest
    needs: bundle-validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Bundle Image (No Push)
        run: |
          echo "ðŸ—ï¸  Building bundle image..."
          docker build -f bundle.Dockerfile -t jupyter-notebook-validator-operator-bundle:test .
          echo "âœ… Bundle image built successfully"

      - name: Inspect Bundle Image
        run: |
          echo "ðŸ” Inspecting bundle image labels..."
          docker inspect jupyter-notebook-validator-operator-bundle:test --format='{{json .Config.Labels}}' | jq .
          echo "âœ… Bundle image inspection completed"

  bundle-scorecard:
    name: Run Scorecard Tests
    runs-on: ubuntu-latest
    needs: bundle-validate
    if: github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install operator-sdk
        run: |
          export ARCH=$(case $(uname -m) in x86_64) echo -n amd64 ;; aarch64) echo -n arm64 ;; *) echo -n $(uname -m) ;; esac)
          export OS=$(uname | awk '{print tolower($0)}')
          export OPERATOR_SDK_DL_URL=https://github.com/operator-framework/operator-sdk/releases/download/${{ env.OPERATOR_SDK_VERSION }}
          curl -LO ${OPERATOR_SDK_DL_URL}/operator-sdk_${OS}_${ARCH}
          chmod +x operator-sdk_${OS}_${ARCH}
          sudo mv operator-sdk_${OS}_${ARCH} /usr/local/bin/operator-sdk

      - name: Create Kind Cluster
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: scorecard-test

      - name: Build and Load Operator Image
        run: |
          echo "ðŸ—ï¸  Building operator image..."
          docker build -t jupyter-notebook-validator-operator:scorecard .
          kind load docker-image jupyter-notebook-validator-operator:scorecard --name scorecard-test

      - name: Build and Load Bundle Image
        run: |
          echo "ðŸ—ï¸  Building bundle image..."
          docker build -f bundle.Dockerfile -t jupyter-notebook-validator-operator-bundle:scorecard .
          kind load docker-image jupyter-notebook-validator-operator-bundle:scorecard --name scorecard-test

      - name: Run Scorecard Tests
        run: |
          echo "ðŸ§ª Running scorecard tests..."
          operator-sdk scorecard ./bundle \
            --kubeconfig=$HOME/.kube/config \
            --wait-time=120s \
            --output=text || true
          echo "âœ… Scorecard tests completed"

  summary:
    name: Bundle Validation Summary
    runs-on: ubuntu-latest
    needs: [bundle-validate, bundle-build]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Summary
        run: |
          # Get version from Makefile
          VERSION=$(grep "^VERSION ?=" Makefile | cut -d'=' -f2 | tr -d ' ')
          BRANCH="${GITHUB_REF_NAME}"
          
          echo "## OLM Bundle Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${BRANCH}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validation Results:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Basic validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… OperatorHub validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Operator Framework suite" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Bundle image build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Upgrade Chain (ADR-047):" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "v1.0.3 â†’ v1.0.7 (OCP 4.18) â†’ v1.0.8 (OCP 4.19) â†’ v1.0.9 (OCP 4.20)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version Mapping:" >> $GITHUB_STEP_SUMMARY
          echo "| Version | OpenShift | Branch |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1.0.7 | 4.18+ | release-4.18 |" >> $GITHUB_STEP_SUMMARY
          echo "| 1.0.8 | 4.19+ | release-4.19 |" >> $GITHUB_STEP_SUMMARY
          echo "| 1.0.9 | 4.20+ | release-4.20 |" >> $GITHUB_STEP_SUMMARY
