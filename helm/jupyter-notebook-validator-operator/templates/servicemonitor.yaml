{{- if and .Values.prometheus.enabled .Values.operator.metrics.enabled -}}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "jupyter-notebook-validator-operator.fullname" . }}-metrics-monitor
  namespace: {{ .Values.prometheus.namespace | default .Release.Namespace }}
  labels:
    {{- include "jupyter-notebook-validator-operator.labels" . | nindent 4 }}
    control-plane: controller-manager
    app.kubernetes.io/component: observability
    {{- with .Values.prometheus.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  endpoints:
  - path: /metrics
    {{- if .Values.operator.metrics.authProxy.enabled }}
    port: https
    scheme: https
    bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    tlsConfig:
      insecureSkipVerify: true
    {{- else }}
    port: metrics
    scheme: http
    {{- end }}
    interval: {{ .Values.prometheus.interval }}
    scrapeTimeout: {{ .Values.prometheus.scrapeTimeout }}
    # Relabeling to add useful labels
    relabelings:
      # Add namespace label
      - sourceLabels: [__meta_kubernetes_namespace]
        targetLabel: namespace
      # Add pod label
      - sourceLabels: [__meta_kubernetes_pod_name]
        targetLabel: pod
      # Add service label
      - sourceLabels: [__meta_kubernetes_service_name]
        targetLabel: service
    # Metric relabeling for filtering and optimization
    metricRelabelings:
      # Keep only operator-specific metrics
      - sourceLabels: [__name__]
        regex: 'notebookvalidationjob_.*'
        action: keep
      # Add operator label to all metrics
      - targetLabel: operator
        replacement: jupyter-notebook-validator
  selector:
    matchLabels:
      {{- include "jupyter-notebook-validator-operator.selectorLabels" . | nindent 6 }}
      control-plane: controller-manager
{{- end }}

